---
phase: 03-stt-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/services/call-manager.ts
autonomous: true

must_haves:
  truths:
    - "CallManager uses AWSTranscribeSTT instead of DeepgramSTT"
    - "All existing call flows work unchanged (same event handling)"
    - "Barge-in (interruption) still works when caller speaks during bot response"
    - "Utterance buffering and timeout logic unchanged"
  artifacts:
    - path: "src/services/call-manager.ts"
      provides: "CallManager using AWS Transcribe STT"
      contains: "AWSTranscribeSTT"
  key_links:
    - from: "src/services/call-manager.ts"
      to: "src/services/aws-transcribe-stt.ts"
      via: "import AWSTranscribeSTT"
      pattern: "import.*AWSTranscribeSTT.*from"
---

<objective>
Wire AWSTranscribeSTT into CallManager, replacing DeepgramSTT import.

Purpose: Complete the STT migration by integrating the new AWS-based STT service into the call flow.

Output: CallManager using AWS Transcribe for speech recognition with zero behavior change.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output (AWSTranscribeSTT implementation)
@.planning/phases/03-stt-migration/03-01-SUMMARY.md

# File to modify
@src/services/call-manager.ts

# New STT implementation
@src/services/aws-transcribe-stt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace DeepgramSTT import with AWSTranscribeSTT in call-manager.ts</name>
  <files>src/services/call-manager.ts</files>
  <action>
    1. Change import from:
       `import { DeepgramSTT } from './stt';`
       to:
       `import { AWSTranscribeSTT } from './aws-transcribe-stt';`

    2. Change the ActiveCall interface stt type from DeepgramSTT to AWSTranscribeSTT

    3. Change the instantiation in initializeCall from:
       `const stt = new DeepgramSTT();`
       to:
       `const stt = new AWSTranscribeSTT();`

    No other changes needed - the event handlers already use the EventEmitter interface
    which AWSTranscribeSTT implements identically to DeepgramSTT.
  </action>
  <verify>
    ```bash
    # Verify import changed
    grep "AWSTranscribeSTT" src/services/call-manager.ts

    # Verify no DeepgramSTT references remain
    ! grep "DeepgramSTT" src/services/call-manager.ts

    # TypeScript compiles
    npx tsc --noEmit
    ```
  </verify>
  <done>
    CallManager imports and uses AWSTranscribeSTT, TypeScript compiles, no DeepgramSTT references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify ActiveCall interface type consistency</name>
  <files>src/services/call-manager.ts</files>
  <action>
    Verify the ActiveCall interface stt field is typed correctly:

    ```typescript
    export interface ActiveCall {
      // ...other fields
      stt: AWSTranscribeSTT;  // Changed from DeepgramSTT
      // ...
    }
    ```

    If using EventEmitter base type for flexibility, that's acceptable since
    both DeepgramSTT and AWSTranscribeSTT extend EventEmitter with identical
    event signatures.
  </action>
  <verify>
    ```bash
    # Check interface definition
    grep -A 20 "export interface ActiveCall" src/services/call-manager.ts | head -25

    # Full TypeScript check
    npx tsc --noEmit
    ```
  </verify>
  <done>
    ActiveCall.stt is typed as AWSTranscribeSTT (or compatible EventEmitter type).
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
npx tsc --noEmit

# No Deepgram imports in call-manager
! grep -E "from.*stt|DeepgramSTT" src/services/call-manager.ts

# AWSTranscribeSTT is used
grep "AWSTranscribeSTT" src/services/call-manager.ts

# Run any existing call-manager tests
npm test -- src/services/call-manager.test.ts 2>/dev/null || echo "No call-manager tests"
```
</verification>

<success_criteria>
- [ ] call-manager.ts imports AWSTranscribeSTT from './aws-transcribe-stt'
- [ ] No references to DeepgramSTT in call-manager.ts
- [ ] ActiveCall interface uses AWSTranscribeSTT type
- [ ] TypeScript compiles without errors
- [ ] Event handler code unchanged (same API)
</success_criteria>

<output>
After completion, create `.planning/phases/03-stt-migration/03-02-SUMMARY.md`
</output>
