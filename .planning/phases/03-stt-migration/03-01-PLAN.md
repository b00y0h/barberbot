---
phase: 03-stt-migration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/services/aws-transcribe-stt.ts
  - src/services/aws-transcribe-stt.test.ts
autonomous: true

must_haves:
  truths:
    - "AWSTranscribeSTT emits 'transcript' events with (text: string, isFinal: boolean)"
    - "AWSTranscribeSTT emits 'utterance_end' events when speaker finishes"
    - "AWSTranscribeSTT emits 'error' events on connection/transcription errors"
    - "AWSTranscribeSTT emits 'close' events when stream ends"
    - "sendAudio() converts mulaw to PCM and sends to Transcribe"
    - "start() initiates streaming connection to AWS Transcribe"
    - "stop() cleanly closes connection and emits close event"
  artifacts:
    - path: "src/services/aws-transcribe-stt.ts"
      provides: "AWSTranscribeSTT class with EventEmitter interface"
      exports: ["AWSTranscribeSTT"]
    - path: "src/services/aws-transcribe-stt.test.ts"
      provides: "Tests for AWSTranscribeSTT behavior"
      min_lines: 50
  key_links:
    - from: "src/services/aws-transcribe-stt.ts"
      to: "src/services/aws-clients.ts"
      via: "getTranscribeClient() import"
      pattern: "getTranscribeClient"
    - from: "src/services/aws-transcribe-stt.ts"
      to: "src/services/audio-convert.ts"
      via: "mulawToPcm() for audio conversion"
      pattern: "mulawToPcm"
---

<objective>
Create AWSTranscribeSTT class that wraps AWS Transcribe Streaming with EventEmitter interface matching DeepgramSTT.

Purpose: Enable drop-in replacement of Deepgram STT with AWS Transcribe while preserving CallManager integration.

Output: Working AWSTranscribeSTT class with tests proving EventEmitter compatibility.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stt-migration/03-CONTEXT.md

# Prior phase outputs
@.planning/phases/01-infrastructure-setup/01-01-SUMMARY.md
@.planning/phases/02-audio-pipeline-foundation/02-01-SUMMARY.md

# Existing code to match
@src/services/stt.ts

# Dependencies
@src/services/aws-clients.ts
@src/services/audio-convert.ts
</context>

<feature>
  <name>AWS Transcribe Streaming STT with DeepgramSTT-compatible EventEmitter</name>
  <files>src/services/aws-transcribe-stt.ts, src/services/aws-transcribe-stt.test.ts</files>
  <behavior>
    The AWSTranscribeSTT class must:
    1. Extend EventEmitter (like DeepgramSTT)
    2. Implement start() -> Promise<void> to initiate streaming connection
    3. Implement sendAudio(audioData: Buffer) -> void to send mulaw audio (converts to PCM internally)
    4. Implement stop() -> void to close connection cleanly

    Events emitted (matching DeepgramSTT exactly):
    - 'transcript' (text: string, isFinal: boolean) - when speech is recognized
    - 'utterance_end' () - when AWS detects end of utterance (speaker finished)
    - 'error' (err: Error) - on any error
    - 'close' () - when connection closes

    Audio handling:
    - Receives mulaw 8kHz Buffer from Twilio (same as DeepgramSTT.sendAudio)
    - Converts to PCM16 8kHz using mulawToPcm() before sending to AWS
    - AWS Transcribe Streaming expects PCM 16-bit signed little-endian

    AWS Transcribe configuration:
    - Language: en-US (with IdentifyMultipleLanguages for accent support per CONTEXT.md)
    - Sample rate: 8000 Hz
    - Media encoding: pcm (16-bit signed little-endian)
    - Enable partial results for interim transcripts
    - Use VoiceId configuration for utterance segmentation

    Test cases:
    - start() establishes AWS Transcribe Streaming connection
    - sendAudio() converts mulaw to PCM and sends to stream
    - Transcript results emit 'transcript' event with text and isFinal flag
    - Utterance end detection emits 'utterance_end' event
    - Connection errors emit 'error' event
    - stop() closes connection and emits 'close' event
    - Multiple sendAudio() calls accumulate and stream correctly
  </behavior>
  <implementation>
    Use @aws-sdk/client-transcribe-streaming StartStreamTranscriptionCommand with:
    - AudioStream as async generator yielding AudioEvent chunks
    - Process TranscriptResultStream events to emit transcript/utterance_end
    - Handle errors from stream and emit 'error' events
    - Implement graceful cleanup on stop()

    Key implementation notes:
    - AWS Transcribe uses async iterables for bidirectional streaming
    - Create an async generator to yield audio chunks from sendAudio() calls
    - Buffer audio chunks until stream is ready
    - Map AWS TranscriptEvent to our event format
    - Map AWS UtteranceEvent or silence detection to utterance_end
  </implementation>
</feature>

<verification>
```bash
# Run tests
npm test -- src/services/aws-transcribe-stt.test.ts

# TypeScript compilation
npx tsc --noEmit

# Verify exports match interface
grep -E "export class AWSTranscribeSTT" src/services/aws-transcribe-stt.ts
```
</verification>

<success_criteria>
- [ ] AWSTranscribeSTT class exists and extends EventEmitter
- [ ] All 4 events match DeepgramSTT: transcript, utterance_end, error, close
- [ ] start(), sendAudio(Buffer), stop() methods match DeepgramSTT signature
- [ ] Tests pass verifying event emission behavior
- [ ] TypeScript compiles without errors
- [ ] Uses mulawToPcm() for audio conversion
- [ ] Uses getTranscribeClient() for AWS client
</success_criteria>

<output>
After completion, create `.planning/phases/03-stt-migration/03-01-SUMMARY.md`
</output>
