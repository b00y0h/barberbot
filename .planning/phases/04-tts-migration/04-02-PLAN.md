---
phase: 04-tts-migration
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/services/call-manager.ts
autonomous: true

must_haves:
  truths:
    - "CallManager uses AWSPollyTTS instead of TTSService"
    - "Bot speaks responses via AWS Polly during calls"
    - "Barge-in interruption still works (tts.interrupt() called on caller speech)"
    - "TTS done event still triggers mark message for audio completion tracking"
  artifacts:
    - path: "src/services/call-manager.ts"
      provides: "CallManager using AWSPollyTTS for voice responses"
      contains: "AWSPollyTTS"
  key_links:
    - from: "src/services/call-manager.ts"
      to: "src/services/aws-polly-tts.ts"
      via: "import AWSPollyTTS"
      pattern: "from.*aws-polly-tts"
---

<objective>
Wire AWSPollyTTS into CallManager to replace ElevenLabs/Deepgram TTS.

Purpose: Complete the TTS migration by integrating Polly-based TTS into the call flow.

Output: CallManager uses AWSPollyTTS for all bot voice responses.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-tts-migration/04-01-SUMMARY.md

# Files to modify
@src/services/call-manager.ts (current TTS usage)
@src/services/aws-polly-tts.ts (new TTS implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace TTSService import with AWSPollyTTS</name>
  <files>src/services/call-manager.ts</files>
  <action>
Update CallManager to use AWSPollyTTS instead of TTSService:

1. **Change import**:
   ```typescript
   // Before
   import { TTSService } from './tts';

   // After
   import { AWSPollyTTS } from './aws-polly-tts';
   ```

2. **Update ActiveCall interface** (if type is referenced):
   ```typescript
   tts: AWSPollyTTS;  // Was: TTSService
   ```

3. **Update initializeCall()**:
   ```typescript
   // Before
   const tts = new TTSService();

   // After
   const tts = new AWSPollyTTS();
   ```

4. **Update speakResponse()**:
   ```typescript
   // Before
   const tts = new TTSService();

   // After
   const tts = new AWSPollyTTS();
   ```

The AWSPollyTTS class has the same interface (synthesize, interrupt, events: audio, done, error) so the integration should be drop-in. No other changes needed to event handlers.

Verify the following behaviors are preserved:
- `tts.on('audio', ...)` still works for streaming chunks
- `tts.on('done', ...)` still triggers mark message
- `tts.on('error', ...)` still logs and resolves
- `call.tts.interrupt()` still called on barge-in
  </action>
  <verify>npx tsc --noEmit (TypeScript compiles without errors)</verify>
  <done>CallManager imports and uses AWSPollyTTS, no TTSService references remain</done>
</task>

<task type="auto">
  <name>Task 2: Verify integration with existing tests</name>
  <files>src/services/call-manager.ts</files>
  <action>
Run the test suite to verify the integration doesn't break existing functionality:

```bash
npm test
```

Since call-manager.ts doesn't have direct unit tests (it integrates STT, TTS, and conversation services), we verify through:

1. TypeScript compilation passing
2. No test regressions in related modules
3. Code review of event handler consistency

If any tests fail related to TTS mocking, update mocks to use AWSPollyTTS instead of TTSService.

Check the following event flow is maintained:
- speakResponse() creates new AWSPollyTTS instance
- tts.on('audio', ...) sends base64 media to Twilio
- tts.on('done', ...) sets isBotSpeaking = false and sends mark
- tts.on('error', ...) logs error and resolves promise
- call.tts reference updated for interrupt capability
  </action>
  <verify>npm test passes with no regressions</verify>
  <done>All existing tests pass, CallManager integration complete</done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
```

Expected: All tests pass

Verify TypeScript compilation:
```bash
npx tsc --noEmit
```

Expected: No errors

Check no old TTS references remain:
```bash
grep -r "TTSService" src/services/call-manager.ts
```

Expected: No matches (old TTSService removed)
</verification>

<success_criteria>
1. CallManager imports AWSPollyTTS instead of TTSService
2. initializeCall() creates AWSPollyTTS instance
3. speakResponse() creates AWSPollyTTS instance for each response
4. Event handlers unchanged (audio, done, error)
5. Barge-in interruption preserved via call.tts.interrupt()
6. All tests pass
7. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-tts-migration/04-02-SUMMARY.md`
</output>
