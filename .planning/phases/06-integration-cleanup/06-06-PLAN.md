---
wave: 3
depends_on:
  - "06-01"
  - "06-02"
  - "06-03"
  - "06-04"
  - "06-05"
files_modified: []
autonomous: true
---

# Plan 06-06: Final Verification and Phase Completion

## Objective

Run comprehensive verification to ensure all Phase 6 success criteria are met. This plan validates the complete integration and cleanup work before marking the phase complete.

## Requirements Addressed

- All Phase 6 requirements (final verification)
- INTG-01, INTG-02, INTG-03, INFRA-03, INFRA-04

## Tasks

<task id="1" title="Verify TypeScript compilation">
Run full TypeScript compilation:

```bash
npx tsc --noEmit
```

Expected: No errors. All imports resolve correctly after legacy code removal.
</task>

<task id="2" title="Run full test suite">
Run all tests:

```bash
npm test
```

Expected: All tests pass, including:
- Unit tests for audio conversion, STT, TTS, conversation
- Integration tests for call flow scenarios
- Environment validation tests
</task>

<task id="3" title="Verify legacy code removal" depends_on="1,2">
Confirm legacy files are deleted:

```bash
# These files should NOT exist
ls src/services/stt.ts 2>/dev/null && echo "ERROR: stt.ts still exists"
ls src/services/tts.ts 2>/dev/null && echo "ERROR: tts.ts still exists"
ls src/services/conversation.ts 2>/dev/null && echo "ERROR: conversation.ts still exists"

# These files SHOULD exist (AWS replacements)
ls src/services/aws-transcribe-stt.ts && echo "aws-transcribe-stt.ts exists"
ls src/services/aws-polly-tts.ts && echo "aws-polly-tts.ts exists"
ls src/services/bedrock-conversation.ts && echo "bedrock-conversation.ts exists"
```
</task>

<task id="4" title="Verify dependencies removed" depends_on="1,2">
Confirm legacy npm packages are removed:

```bash
# Check package.json
grep -E '"openai"' package.json && echo "ERROR: openai still in dependencies"
grep -E '"@deepgram/sdk"' package.json && echo "ERROR: @deepgram/sdk still in dependencies"

# Check package-lock.json (if exists)
grep -E '"openai"' package-lock.json 2>/dev/null && echo "ERROR: openai in lock file"
grep -E '"@deepgram/sdk"' package-lock.json 2>/dev/null && echo "ERROR: @deepgram/sdk in lock file"

# Verify AWS deps ARE present
grep -E '"@aws-sdk/client-bedrock-runtime"' package.json && echo "AWS Bedrock SDK present"
grep -E '"@aws-sdk/client-transcribe-streaming"' package.json && echo "AWS Transcribe SDK present"
grep -E '"@aws-sdk/client-polly"' package.json && echo "AWS Polly SDK present"
```
</task>

<task id="5" title="Verify startup validation works" depends_on="1,2">
Test that startup validation rejects legacy env vars:

```bash
# Test with legacy var set (should exit with error)
OPENAI_API_KEY=test-key npm start 2>&1 | head -20

# Expected output should include:
# "Configuration Error:"
# "Legacy environment variable OPENAI_API_KEY is set but no longer used"
```

Then verify normal startup works:

```bash
# Without legacy vars, should start normally (kill after a few seconds)
timeout 5 npm start 2>&1 | head -20 || true
```
</task>

<task id="6" title="Check success criteria" depends_on="3,4,5">
Verify each Phase 6 success criterion:

1. **Inbound call journey** (INTG-01):
   - Integration tests verify call flow scenarios
   - CallManager wired to Bedrock conversation

2. **Barge-in/interruption** (INTG-02):
   - AWSPollyTTS has interrupt() method
   - CallManager handles isBotSpeaking state
   - STT transcript triggers TTS interrupt

3. **CallManager interface unchanged** (INTG-03):
   - ActiveCall interface has same properties
   - Same exported functions (initializeCall, getActiveCall, etc.)

4. **Old dependencies removed** (INFRA-03):
   - openai package removed
   - @deepgram/sdk package removed

5. **Old env vars validated** (INFRA-04):
   - validateNoLegacyProviders() function exists
   - Startup exits if legacy vars set
   - .env.example updated

Print summary:

```bash
echo "=== Phase 6 Success Criteria Check ==="
echo ""
echo "INTG-01 (Full call journey): ✓ Integration tests verify 4 scenarios"
echo "INTG-02 (Barge-in): ✓ TTS interrupt + isBotSpeaking state"
echo "INTG-03 (Interface unchanged): ✓ ActiveCall interface preserved"
echo "INFRA-03 (Dependencies removed): ✓ openai, @deepgram/sdk removed"
echo "INFRA-04 (Env var validation): ✓ Startup rejects legacy vars"
echo ""
echo "=== Phase 6 Complete ==="
```
</task>

## Verification

- [ ] TypeScript compiles without errors
- [ ] All tests pass (unit + integration)
- [ ] Legacy code files deleted (stt.ts, tts.ts, conversation.ts)
- [ ] Legacy dependencies removed (openai, @deepgram/sdk)
- [ ] Startup validation rejects legacy env vars
- [ ] All 5 success criteria verified

## must_haves

- [ ] Clean TypeScript compilation
- [ ] All tests pass
- [ ] No legacy code or dependencies remain
- [ ] Startup validation functional
- [ ] All INTG and INFRA requirements met
