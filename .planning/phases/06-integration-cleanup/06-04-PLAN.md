---
wave: 2
depends_on:
  - "06-02"
files_modified:
  - src/config/env.ts
  - src/config/env.test.ts
  - src/index.ts
autonomous: true
---

# Plan 06-04: Add Startup Validation for Legacy Environment Variables

## Objective

Add startup validation that errors if old provider environment variables are still set. This prevents misconfiguration where someone sets OPENAI_API_KEY, DEEPGRAM_API_KEY, or ELEVENLABS_API_KEY expecting them to work when the system now uses only AWS.

## Requirements Addressed

- INFRA-04: Old provider environment variables removed (validation that they shouldn't be used)

## Tasks

<task id="1" title="Create env validation test file">
Create `/workspace/src/config/env.test.ts` with TDD tests:

```typescript
import { describe, it, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert';

describe('Environment Configuration', () => {
  describe('Legacy provider validation', () => {
    const originalEnv = { ...process.env };

    beforeEach(() => {
      // Clear legacy vars before each test
      delete process.env.OPENAI_API_KEY;
      delete process.env.DEEPGRAM_API_KEY;
      delete process.env.ELEVENLABS_API_KEY;
    });

    afterEach(() => {
      // Restore original env
      process.env = { ...originalEnv };
    });

    it('validateNoLegacyProviders returns empty array when no legacy vars set', async () => {
      // Dynamic import to get fresh module
      const { validateNoLegacyProviders } = await import('./env');
      const errors = validateNoLegacyProviders();
      assert.deepStrictEqual(errors, []);
    });

    it('validateNoLegacyProviders returns error for OPENAI_API_KEY', async () => {
      process.env.OPENAI_API_KEY = 'sk-test';
      // Need to re-import to pick up env changes
      const envModule = await import('./env');
      const errors = envModule.validateNoLegacyProviders();
      assert.ok(errors.some(e => e.includes('OPENAI_API_KEY')));
    });

    it('validateNoLegacyProviders returns error for DEEPGRAM_API_KEY', async () => {
      process.env.DEEPGRAM_API_KEY = 'test-key';
      const envModule = await import('./env');
      const errors = envModule.validateNoLegacyProviders();
      assert.ok(errors.some(e => e.includes('DEEPGRAM_API_KEY')));
    });

    it('validateNoLegacyProviders returns error for ELEVENLABS_API_KEY', async () => {
      process.env.ELEVENLABS_API_KEY = 'test-key';
      const envModule = await import('./env');
      const errors = envModule.validateNoLegacyProviders();
      assert.ok(errors.some(e => e.includes('ELEVENLABS_API_KEY')));
    });

    it('returns multiple errors when multiple legacy vars set', async () => {
      process.env.OPENAI_API_KEY = 'sk-test';
      process.env.DEEPGRAM_API_KEY = 'test-key';
      const envModule = await import('./env');
      const errors = envModule.validateNoLegacyProviders();
      assert.strictEqual(errors.length, 2);
    });
  });

  describe('AWS configuration', () => {
    it('env.aws has required properties', async () => {
      const { env } = await import('./env');

      assert.ok('accessKeyId' in env.aws);
      assert.ok('secretAccessKey' in env.aws);
      assert.ok('region' in env.aws);
    });

    it('AWS region defaults to us-east-2', async () => {
      const originalRegion = process.env.AWS_REGION;
      delete process.env.AWS_REGION;

      // Clear module cache and re-import
      const envPath = require.resolve('./env');
      delete require.cache[envPath];

      const { env } = await import('./env');
      assert.strictEqual(env.aws.region, 'us-east-2');

      // Restore
      if (originalRegion) process.env.AWS_REGION = originalRegion;
    });
  });
});
```
</task>

<task id="2" title="Update env.ts to remove legacy config and add validation" depends_on="1">
Update `/workspace/src/config/env.ts`:

1. Remove the legacy provider configs from EnvConfig interface
2. Remove the required() calls for legacy vars
3. Add validateNoLegacyProviders function

```typescript
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../../.env') });

export interface EnvConfig {
  port: number;
  baseUrl: string;
  twilio: {
    accountSid: string;
    authToken: string;
    phoneNumber: string;
  };
  aws: {
    accessKeyId: string;
    secretAccessKey: string;
    region: string;
  };
  databasePath: string;
}

function required(name: string): string {
  const val = process.env[name];
  if (!val) {
    console.warn(`Warning: Missing environment variable ${name}`);
    return '';
  }
  return val;
}

/**
 * Validate that legacy provider environment variables are not set.
 * These providers have been replaced by AWS services.
 *
 * @returns Array of error messages (empty if no legacy vars found)
 */
export function validateNoLegacyProviders(): string[] {
  const errors: string[] = [];
  const legacyVars = [
    { name: 'OPENAI_API_KEY', replacement: 'AWS_ACCESS_KEY_ID (Bedrock)' },
    { name: 'DEEPGRAM_API_KEY', replacement: 'AWS_ACCESS_KEY_ID (Transcribe)' },
    { name: 'ELEVENLABS_API_KEY', replacement: 'AWS_ACCESS_KEY_ID (Polly)' },
  ];

  for (const { name, replacement } of legacyVars) {
    if (process.env[name]) {
      errors.push(
        `Legacy environment variable ${name} is set but no longer used. ` +
        `Remove it and configure ${replacement} instead.`
      );
    }
  }

  return errors;
}

export const env: EnvConfig = {
  port: parseInt(process.env.PORT || '3100', 10),
  baseUrl: process.env.BASE_URL || `http://localhost:${process.env.PORT || '3100'}`,
  twilio: {
    accountSid: required('TWILIO_ACCOUNT_SID'),
    authToken: required('TWILIO_AUTH_TOKEN'),
    phoneNumber: required('TWILIO_PHONE_NUMBER'),
  },
  aws: {
    accessKeyId: required('AWS_ACCESS_KEY_ID'),
    secretAccessKey: required('AWS_SECRET_ACCESS_KEY'),
    region: process.env.AWS_REGION || 'us-east-2',
  },
  databasePath: process.env.DATABASE_PATH || './data/barberbot.db',
};
```
</task>

<task id="3" title="Add startup validation call to index.ts" depends_on="1,2">
Update `/workspace/src/index.ts` to call the validation on startup:

Add near the top of the file (after imports):

```typescript
import { validateNoLegacyProviders } from './config/env';

// Validate no legacy provider env vars are set
const legacyErrors = validateNoLegacyProviders();
if (legacyErrors.length > 0) {
  console.error('Configuration Error:');
  for (const error of legacyErrors) {
    console.error(`  - ${error}`);
  }
  console.error('\nThis system uses AWS services exclusively. Remove legacy environment variables.');
  process.exit(1);
}
```
</task>

<task id="4" title="Run tests and verify" depends_on="2,3">
Run the tests:

```bash
npm test -- src/config/env.test.ts
```

All tests should pass.

Then verify full compilation:

```bash
npx tsc --noEmit
```
</task>

## Verification

- [ ] validateNoLegacyProviders function added to env.ts
- [ ] Function returns errors for OPENAI_API_KEY, DEEPGRAM_API_KEY, ELEVENLABS_API_KEY
- [ ] Legacy provider configs removed from EnvConfig interface
- [ ] index.ts calls validation on startup and exits if legacy vars found
- [ ] Tests pass: `npm test -- src/config/env.test.ts`
- [ ] TypeScript compiles: `npx tsc --noEmit`

## must_haves

- [ ] validateNoLegacyProviders function exported from env.ts
- [ ] Startup validation in index.ts with helpful error messages
- [ ] Legacy provider config removed from EnvConfig interface
- [ ] Process exits with error code 1 if legacy vars detected
