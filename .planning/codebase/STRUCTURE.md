# Codebase Structure

**Analysis Date:** 2026-01-27

## Directory Layout

```
barberbot/
├── src/                           # TypeScript source code
│   ├── index.ts                   # HTTP/WebSocket server entry point
│   ├── config/                    # Configuration and environment
│   │   ├── env.ts                 # Environment variable schema and loader
│   │   └── business.ts            # Business profile interface and singleton loader
│   ├── database/                  # SQLite database layer
│   │   ├── index.ts               # Database connection and singleton
│   │   └── schema.ts              # Schema initialization (customers, appointments, calls)
│   ├── prompts/                   # AI prompt generation
│   │   └── system.ts              # Dynamic system prompt builder for OpenAI
│   ├── routes/                    # Express route handlers
│   │   ├── voice.ts               # Twilio webhook routes (/voice/incoming, /voice/status)
│   │   └── admin.ts               # Admin API routes (/api/calls, /api/customers, etc.)
│   ├── services/                  # Core business logic services
│   │   ├── audio-pipeline.ts      # WebSocket media stream handler
│   │   ├── call-manager.ts        # Call lifecycle and orchestration
│   │   ├── conversation.ts        # OpenAI LLM and tool-calling logic
│   │   ├── customers.ts           # Database CRUD for calls, customers, appointments
│   │   ├── stt.ts                 # Deepgram speech-to-text service
│   │   ├── tts.ts                 # ElevenLabs/Deepgram text-to-speech with codec conversion
│   │   └── twilio.ts              # Twilio client factory and TwiML generation
│   └── public/                    # Static web assets (dashboard HTML/CSS/JS)
├── scripts/                       # Utility scripts
│   ├── seed-db.ts                 # Database seeding with sample data
│   └── test-call.ts               # Test outbound call script
├── data/                          # Data files
│   └── business-profiles/         # Business configuration JSON files
│       └── classic-cuts.json      # Sample barbershop profile
├── dist/                          # Compiled JavaScript output (generated by tsc)
├── node_modules/                 # Dependencies (pnpm)
├── pnpm-lock.yaml                # Dependency lock file
├── tsconfig.json                 # TypeScript compiler configuration
├── package.json                  # Project metadata and scripts
├── .env.example                  # Environment variable template
├── README.md                     # Project documentation
└── .planning/                    # GSD planning documents
    └── codebase/                 # Architecture/structure analysis
```

## Directory Purposes

**src/:**
- Purpose: All TypeScript source code for the application
- Contains: Entry point, routes, services, configuration, database logic
- Key files: `index.ts` (server bootstrap)

**src/config/:**
- Purpose: Configuration loading and management
- Contains: Environment variable schema, business profile loader
- Key files: `env.ts` (env schema), `business.ts` (profile interface and singleton)

**src/database/:**
- Purpose: SQLite database initialization and connection pooling
- Contains: Database connection singleton, schema DDL
- Key files: `index.ts` (connection management)

**src/prompts/:**
- Purpose: Dynamic prompt generation for OpenAI
- Contains: System prompt builder that interpolates business info
- Key files: `system.ts` (builds context-aware system prompt)

**src/routes/:**
- Purpose: Express route handlers for HTTP endpoints
- Contains: Twilio webhook handlers, admin API endpoints
- Key files: `voice.ts` (Twilio integration), `admin.ts` (dashboard API)

**src/services/:**
- Purpose: Business logic services and third-party integrations
- Contains: Call management, LLM, STT, TTS, database operations
- Key files: `call-manager.ts` (call orchestration), `conversation.ts` (LLM logic)

**src/public/:**
- Purpose: Static web assets served at root
- Contains: Dashboard HTML, CSS, JavaScript
- Key files: `index.html` (admin dashboard)

**scripts/:**
- Purpose: Utility scripts for development and testing
- Contains: Database seeding, test call initiation
- Key files: `seed-db.ts` (sample data), `test-call.ts` (manual testing)

**data/business-profiles/:**
- Purpose: JSON business configuration files
- Contains: Business name, hours, services, staff, policies
- Key files: `classic-cuts.json` (barbershop example)

## Key File Locations

**Entry Points:**
- `src/index.ts`: Main HTTP/WebSocket server bootstrap; initializes Express, database, WebSocket server

**Configuration:**
- `src/config/env.ts`: Environment variable schema (port, API keys, database path)
- `src/config/business.ts`: Business profile loader (reads JSON from data/business-profiles/)
- `.env.example`: Template for required environment variables

**Core Logic:**
- `src/services/call-manager.ts`: Call lifecycle management, STT/TTS orchestration
- `src/services/conversation.ts`: OpenAI LLM integration with tool-calling
- `src/services/audio-pipeline.ts`: WebSocket media stream handling

**Integration:**
- `src/services/twilio.ts`: Twilio client and TwiML generation
- `src/services/stt.ts`: Deepgram live transcription
- `src/services/tts.ts`: ElevenLabs/Deepgram synthesis with codec conversion

**Database:**
- `src/database/index.ts`: SQLite connection singleton
- `src/database/schema.ts`: Table definitions (customers, appointments, calls)
- `src/services/customers.ts`: CRUD operations and queries

**API Routes:**
- `src/routes/voice.ts`: `POST /voice/incoming` (Twilio webhook), `POST /voice/status` (call status)
- `src/routes/admin.ts`: `GET /api/calls`, `GET /api/customers`, `POST /api/calls/outbound`, etc.

**Testing:**
- `scripts/seed-db.ts`: Populates database with sample customers and appointments
- `scripts/test-call.ts`: Initiates outbound call via admin API

## Naming Conventions

**Files:**
- Services: `{service-name}.ts` (e.g., `call-manager.ts`, `audio-pipeline.ts`)
- Routes: `{resource-name}.ts` (e.g., `voice.ts`, `admin.ts`)
- Database: `{layer}.ts` (e.g., `schema.ts`, `index.ts`)
- Configs: `{config-type}.ts` (e.g., `env.ts`, `business.ts`)

**Directories:**
- Service grouping: `src/services/` for all business logic
- Route grouping: `src/routes/` for all HTTP endpoints
- Config grouping: `src/config/` for all configuration
- Database grouping: `src/database/` for persistence layer

**Functions:**
- Async operations: `async function` prefix (e.g., `async function initializeCall()`)
- Event emitters: Class suffix (e.g., `DeepgramSTT`, `TTSService`)
- Handlers: `handle{Action}` pattern (e.g., `handleMediaStream`, `handleUserUtterance`)
- Getters: `get{Resource}` or `find{Resource}` pattern (e.g., `getDatabase()`, `findCustomerByPhone()`)
- Creators: `create{Resource}` pattern (e.g., `createConversation()`, `createCustomer()`)
- Updaters: `update{Resource}` pattern (e.g., `updateCallRecord()`)

**Variables:**
- Single-letter prefixes for clarity: `_client` (singleton), `_profile` (cached)
- Prefixes for state: `is{State}` boolean (e.g., `isBotSpeaking`, `isFinal`)
- Suffix for collections: `s` or specific type (e.g., `activeCalls`, `services`)

**Types/Interfaces:**
- Interfaces: `{Entity}Interface` or `{Entity}` (e.g., `ActiveCall`, `ConversationState`)
- Enums: `{Entity}Type` (e.g., direction: 'inbound' | 'outbound')
- Config objects: `{Config}Interface` (e.g., `EnvConfig`)

## Where to Add New Code

**New Feature (e.g., voicemail support):**
- Primary code: `src/services/{feature-name}.ts`
- Route handler: Add to `src/routes/voice.ts` or `src/routes/admin.ts`
- Database schema: Update `src/database/schema.ts`, add CRUD to `src/services/customers.ts`
- Integration: Add initialization to `src/index.ts` or relevant service

**New Component/Module (e.g., SMS reminders):**
- Implementation: `src/services/{module-name}.ts` as a new service
- Configuration: Add schema to `src/config/env.ts` if external API credentials needed
- Usage: Reference in call manager or conversation service where applicable

**New Endpoint (e.g., `/api/analytics`):**
- Route handler: Add to `src/routes/admin.ts`
- Supporting query: Add function to `src/services/customers.ts` with database query
- Response type: Define in TypeScript at top of route or in customers.ts

**Utilities (e.g., audio codec helpers):**
- Shared helpers: Add to existing service file if specialized (e.g., `tts.ts` for audio conversion)
- Generic utilities: Create `src/utils/{utility-name}.ts` if reused across services

**Business Logic Enhancements (e.g., new tool calling capability):**
- Tool definition: Add to `tools` array in `src/services/conversation.ts`
- Tool handler: Add case to `handleToolCall()` function in `src/services/conversation.ts`
- Database support: Add CRUD operation to `src/services/customers.ts` if needed

**Prompts (e.g., specialized instructions for callbacks):**
- System prompt: Modify `buildSystemPrompt()` in `src/prompts/system.ts`
- Conversation-specific: Add to `ConversationState` and interpolate in prompt

## Special Directories

**dist/:**
- Purpose: Compiled JavaScript output from TypeScript
- Generated: Yes (via `npm run build` / `tsc`)
- Committed: No (in .gitignore)
- Note: Created by TypeScript compiler; production uses files from dist/

**node_modules/:**
- Purpose: Package dependencies
- Generated: Yes (via `pnpm install`)
- Committed: No (in .gitignore)
- Lockfile: `pnpm-lock.yaml` tracks exact versions

**public/:**
- Purpose: Static files served directly by Express
- Generated: No (manually created/maintained)
- Committed: Yes
- Note: Mounted at `/` in express.static; dashboard HTML served here

**.env:**
- Purpose: Runtime environment variables (secrets, API keys, config)
- Generated: No (manually created from .env.example)
- Committed: No (in .gitignore, .env.example committed as template)
- Note: Required at runtime; use .env.example as reference

---

*Structure analysis: 2026-01-27*
